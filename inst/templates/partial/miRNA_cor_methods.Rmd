```{r "{{method_name}}_cor_miRNA_config", include = FALSE, warnig = FALSE}
# ###########################################
# ################# READ ME #################
# ###########################################
#
# This template assumes that the following variables exists
# => current_organism_info$Bioconductor_DB[1] :: organism database to translate genes
# => method :: method object
# => method_name :: method name
  
method<- "{{method_name}}"

strat_pairs <- all_pairs[, get(method)]
strat_data <- all_pairs[strat_pairs,]
strat_data$miRNA_names <- mirna_names[match(strat_data$miRNAseq, mirna_names$Accession), "TargetName"]
strat_data <- merge(strat_data, gene_id_translation, by.x = "RNAseq", by.y = "ensembl_gene_id", all.x = TRUE)


strat_data <- strat_data[,c("miRNA_names", "miRNAseq","Symbol","RNAseq", "predicted", "validated", "multimir","pred_and_val","predicted_c", "validated_c","entrezgene")]

strat_data_table <- strat_data[,c("miRNA_names", "miRNAseq","Symbol","RNAseq", "predicted_c", "validated_c","entrezgene")]



DH_results_genes <- match(strat_data_table$RNAseq, RNAseq$DH_results$gene_name)
strat_data_table$target_deg_tag <- RNAseq$DH_results[DH_results_genes, "genes_tag"]

DH_results_miRNAs <- match(strat_data_table$miRNAseq, miRNAseq$DH_results$gene_name)
approach <- unlist(strsplit(method, "_RNA_vs_miRNA_"))
if (approach[2] != "normalized_counts") {

  strat_data_table$miRNA_mod <- miRNAseq$DH_results[DH_results_miRNAs, "Cluster_ID"]    
  strat_data_table$miRNA_MM <- miRNAseq$DH_results[DH_results_miRNAs, "Cluster_MM"]  

}
if (approach[1] != "normalized_counts") {
  
  strat_data_table$RNA_mod <- RNAseq$DH_results[DH_results_genes, "Cluster_ID"]    
  strat_data_table$RNA_MM <- RNAseq$DH_results[DH_results_genes, "Cluster_MM"]  

}
strat_data_table$mean_logFCs <- RNAseq$DH_results$mean_logFCs[match(strat_data_table$RNAseq, RNAseq$DH_results$gene_name)]




# aux <- as.data.frame(
#   strategies[["normalized_counts_RNA_vs_miRNA_normalized_counts"]][match(
#     rownames(strat_data)[strat_data[,strat_pairs]], 
#     strategies[["normalized_counts_RNA_vs_miRNA_normalized_counts"]]$pair_n), c("correlation", "pval")])

# colnames(aux) <- c("raw_cor", "raw_pval")
# strat_data <- cbind(strat_data, aux)
# all_miRNA_summary <- data.frame()
# strat_data <- data.frame()

```



```{r "{{method_name}}_cor_miRNA_table", echo = FALSE, message=FALSE, warning=FALSE, results = "asis"}
if (nrow(strat_data_table) > 20000){
  cat(paste0("\n\nThis strategy finds too many significant pairs. Please check ", method, "/targets_results_table.txt. \n\n"))

} else {
  DT::datatable(strat_data_table, filter = 'top', rownames = FALSE, extensions = c('Buttons','ColReorder'),
        options = list(
          paging = TRUE,
          colReorder = TRUE,
          dom = 'lftBip',
          buttons = c('copy', 'csv', 'excel')
    ))
}
# strat_data <- data.frame()
```


```{r "{{method_name}}_cor_miRNA_table_error", eval = FALSE, results='asis', echo = FALSE, message=FALSE, warning=FALSE}

cat("This method was launched but no significant miRNA-target gene relations were found in multiMiR.\n")

```


```{r "{{method_name}}_dem_summary_config", echo = FALSE, message=FALSE, warning=FALSE}

# dems <- unique(miRNAseq$DH_results[miRNAseq$DH_results$genes_tag == "PREVALENT_DEG", "gene_name"])
# strat_data <- strat_data[strat_data$miRNAseq %in% dems, ]
all_miRNA_summary <- data.frame( stringsAsFactors = FALSE)
for (mirna in unique(strat_data$miRNA_names)) {
   mirna_info <- strat_data[strat_data$miRNA_names == mirna, ]
#    save(mirna_info, file = "~/proyectos/target_miRNA_2020/test4.RData")
# q()
   dem_summary <- data.frame(stringsAsFactors = FALSE,
               miRNA = mirna,
               sig_targets = length(unique(mirna_info$RNAseq)),
               targets_in_multimir = length(unique(mirna_info$RNAseq[mirna_info$multimir])),
               pred_targets = length(unique(mirna_info$RNAseq[mirna_info$predicted])),
               val_targets = length(unique(mirna_info$RNAseq[mirna_info$validated])),
               pred_and_val_targets = length(unique(mirna_info$RNAseq[mirna_info$pred_and_val]))
             )
   all_miRNA_summary <- rbind(all_miRNA_summary, dem_summary)
}
```

```{r "{{method_name}}_dem_summary_text", echo = FALSE,  results='asis',message=FALSE, warning=FALSE}

cat("### Strategy miRNAs summary\n\n")

```

```{r "{{method_name}}_dem_summary", echo = FALSE, message=FALSE, warning=FALSE}

DT::datatable(all_miRNA_summary, filter = 'top', rownames = FALSE, extensions = c('Buttons','ColReorder'),
      options = list(
        colReorder = TRUE,
        dom = 'lftBip',
        buttons = c('copy', 'csv', 'excel')
    ))

```

```{r "{{method_name}}_dem_table_config", echo = FALSE, message=FALSE, warning=FALSE}

outdir <- file.path(output_files, method)
check_and_create_dir(outdir)
utils::write.table(strat_data_table, file = file.path(outdir, "target_results_table.txt"), quote=FALSE, col.names=TRUE, row.names = FALSE, sep="\t")

```



