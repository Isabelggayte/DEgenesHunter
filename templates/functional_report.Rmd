---
author: "Fernando Moreno Jabato"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    fig_width: 12
---

<style>
    body .main-container {
        max-width: 90%;
    }

    embed {
    	width: 800px;
    	height: 800px;
    }
</style>

```{r config, include = FALSE}
# Prepare recursive text
chunks <- function(code, options = ""){paste(paste("```{r ",options,"}",sep = ""),code,"```",sep="\n")}
render <- function(text){paste(knit(text = paste(text,collapse = "\n")),collapse = "\n")}

# Prepare all HPO reports container
out <- NULL

```




# **DEgenes Hunter - Functional analysis report** 

## **General description of the analysis workflow**

The functional analysis script is based on the gene ID of the DEGs provided for a model organism. BiomaRt package has been included to get the annotations to perform a gene enrichment analysis of molecular functions, biological processes and cellular components with package topGO and a pathway enrichment study with KEGGREST and web service call to the KEGG database. 

Results provided from the functional analysis script are gene enrichment graphs of (i) the complete DEG set and its (ii) overexpressed and (iii) sub-expressed candidates separately. Moreover, it provides the significant KEGG pathway maps as an interactive html file.

In DEgenes Hunter, genes are labeled according the following considerations:

* **Prevalent DEGs:** Differentially expressed genes considered by all packages employed but one.
* **All possible DEGs:** Differentially expressed genes considered by at least one of the R-packages but not enough of them to be considered as "prevalent DEGs".

## **Used data in this analysis**
Specifically, in this experiment set, known experiment labels are:

```{r add_exp_names, echo = FALSE}
	# Obtain experiments names
	# dir <- dirname(opt$countdata_file)
	# experiments <- read.table(file = file.path(dir,"control_treatment.txt"), sep = "\t", quote = "", header = TRUE, stringsAsFactors = FALSE)
	# exp_names <- experiments[which(experiments[,1] == "T"),2]

	out <- unlist(lapply(exp_names,function(names){paste("* ",names,sep="")}))
```

`r paste(knit(text = paste(out,collapse = "\n")),collapse = "\n")`



```{r check_graphs, echo = FALSE}
####################################### GO

# Useful_functions
graph_file_name <- function(path = results_path, file_name, ext = "pdf"){
	return(paste(path,.Platform$file.sep,file_name,".",ext,sep=""))
}
exists_graph_file <- function(path = results_path, file_name, ext = "pdf"){
	f <- graph_file_name(path,file_name,ext)
	return(file.exists(f))
}
exists_enrich_df <- function(var_name,level_depth = 3){
	# Check if it is instantiated
	if(!var_name %in% ls(envir = parent.frame(n = level_depth))){
		return(FALSE)
	}
	# Check if is a DF with info
	df <- get(var_name, envir = parent.frame(n = level_depth))
	if(is.data.frame(df)){
		if(nrow(df) <= 0){
			return(FALSE)
		}
	}else if(typeof(df)=="S4"){
		if(nrow(df@result) <= 0){
			return(FALSE)
		}
	}else if(!is.list(df) & !typeof(df)=="S4"){
		return(FALSE)
	}else if(is.list(df)){
		if(!all(unlist(lapply(df,function(set){
				if(typeof(set)=="S4"){
					if(nrow(set@result) > 0){
						return(TRUE)
					}
					return(FALSE)
				}
				return(FALSE)
			})))){
			return(FALSE)
		}
	}
	# Everything OK
	return(TRUE)
}


# Prepare containers
go_flags <- list()
go_files <- list()

# Define files to be checked
go_enrich_vars <- c("enrich_go","enrich_go_gsea")
graph_files <- c("GO_preval","GO_preval_overex","GO_preval_underex",
				"GO_allpos","GO_allpos_overex","GO_allpos_underex")
go_subontos <- c("BP","MF","CC")
graph_files <- apply(expand.grid(graph_files, go_subontos), 1, paste, collapse="_")

# Check all files
invisible(lapply(graph_files,function(file_name){
	if(exists_graph_file(file_name = file_name)){
		go_flags[file_name] <<- TRUE
		go_files[file_name] <<- graph_file_name(file_name = file_name)
	}else{
		go_flags[file_name] <<- FALSE
	}
}))
# Check GO section
go_flags$GO_SECTION <- any(unlist(go_flags))
# Add CL graphs
invisible(lapply(go_enrich_vars,function(var_name){
	go_flags[var_name] <<- exists_enrich_df(var_name)
}))
# Check GO section
go_flags$GO_CL_SECTION <- any(unlist(go_flags[go_enrich_vars]))





####################################### KEGG

# Prepare containers
kegg_flags <- list()

# Define variables to be checked
kegg_enrich_vars <- c("enrich_ora","enrich_gsea")

# Check all variables
invisible(lapply(kegg_enrich_vars,function(var_name){
	kegg_flags[var_name] <<- exists_enrich_df(var_name)
}))

kegg_flags$KEGG_SECTION <- any(unlist(kegg_flags))



####################################### REACTOME

# Prepare containers
react_flags <- list()

# Define variables to be checked
react_enrich_vars <- c("enrich_react","enrich_react_gsea")

# Check all variables
invisible(lapply(react_enrich_vars,function(var_name){
	react_flags[var_name] <<- exists_enrich_df(var_name)
}))

react_flags$REACT_SECTION <- any(unlist(react_flags))
# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
```


```{r setup_plots, echo=FALSE, results='asis', eval=TRUE}
if(kegg_flags[["enrich_ora"]] | kegg_flags[["enrich_gsea"]] |
	go_flags[["enrich_go"]] | go_flags[["enrich_go_gsea"]] |
	react_flags[["enrich_react"]] | react_flags[["enrich_react_gsea"]]){
	suppressPackageStartupMessages(require(clusterProfiler))
	suppressPackageStartupMessages(require(enrichplot))
}

```
























```{r kegg_main,  results='asis', echo = FALSE, eval = kegg_flags$KEGG_SECTION}
cat("## **KEGG analysis**\n")
```





```{r kegg_ora, results='asis', echo = FALSE, eval = kegg_flags$enrich_ora}
# Main label 
cat("### **Over Representation Analysis**\n")

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- barplot(enrich_ora)
# Display plot
print(pp)


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- dotplot(enrich_ora, showCategory=30)
# Display plot
print(pp)


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- cnetplot(enrich_ora)
# Display plot
print(pp)


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- emapplot(enrich_ora)
# Display plot
print(pp)


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- heatplot(enrich_ora)
# Display plot
print(pp)


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- upsetplot(enrich_ora)
# Display plot
print(pp)
```







```{r kegg_gsea, results='asis', echo = FALSE, eval = kegg_flags$enrich_gsea}
# Main label
cat("### **Gene Set Enrichment Analysis**\n")


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- dotplot(enrich_gsea, showCategory=30)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- cnetplot(enrich_gsea)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- emapplot(enrich_gsea)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- heatplot(enrich_gsea)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- ridgeplot(enrich_gsea)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- gseaplot2(enrich_gsea, geneSetID=1:4, title = enrich_gsea$Description[1], pvalue_table = TRUE)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- gsearank(enrich_gsea, geneSetID=1, title = enrich_gsea$Description[1])
# Display plot
print(pp)
```




```{r display_kegg_res, results='asis', echo = FALSE, eval = kegg_flags$enrich_ora}

cat("## **ClusterProfiler KEGG table**\n")

# Add kegg table
kegg_df <- as.data.frame(enrich_ora)
kegg_df[,1] <- unlist(lapply(enrich_ora[,1],function(id){
	link <- url <- paste0("http://www.kegg.jp/kegg-bin/show_pathway?", id, "/default%3dorange/", enrich_ora[id, "geneID"]) # browseKEGG(enrich_ora, id)
	to_html <- paste0("[",id,"](",link,")")
	# to_HTML <- paste("<a href='",link,"'>",id,"</a>",sep="")
}))

cols_to_show <- c("ID","Description","p.adjust","Count","geneID")
knitr::kable(kegg_df[,cols_to_show])
```




















```{r display_go_main, results='asis', echo = FALSE, eval = go_flags$GO_CL_SECTION}
cat("## **GO Analysis**\n")
```


```{r plot_go_cl, results='asis', echo = FALSE, eval = go_flags$GO_CL_SECTION}
# Plots per sub-ontology
invisible(lapply(names(enrich_go),function(onto){
# for(onto in names(enrich_go)){
	# Special case
	if(nrow(enrich_go[[onto]]@result) <= 0 & nrow(enrich_go_gsea[[onto]]@result) <= 0){
		cat(paste("### **[",onto,"] GO Analysis**<br>This sub-ontology study has been executed but **has not returned any result**\n",sep=""))
	}


	###################################################### ORA PLOTS
	if(nrow(enrich_go[[onto]]@result) > 0){
		# Add main label
		cat(paste("### **[",onto,"] Over Representation Analysis** \n<br>",sep=""))
		# knit(text = knit_expand(text = paste("### **[",onto,"] Over Representation Analysis**\n",sep="")))

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- barplot(enrich_go[[onto]])
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- dotplot(enrich_go[[onto]], showCategory=30)
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- cnetplot(enrich_go[[onto]])
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- emapplot(enrich_go[[onto]])
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- heatplot(enrich_go[[onto]])
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- upsetplot(enrich_go[[onto]])
		print(go_pp)
		cat("\n \n")
	}



	###################################################### GSEA PLOTS
	if(nrow(enrich_go_gsea[[onto]]@result) > 0){
		# Add main label
		cat(paste("### **[",onto,"] Gene Set Expression Analysis** \n<br>",sep=""))
		# knit(text = knit_expand(text = paste("### **[",onto,"] Gene Set Expression Analysis**\n",sep="")))

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- dotplot(enrich_go_gsea[[onto]], showCategory=30)
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- cnetplot(enrich_go_gsea[[onto]])
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- emapplot(enrich_go_gsea[[onto]])
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- heatplot(enrich_go_gsea[[onto]])
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- ridgeplot(enrich_go_gsea[[onto]])
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- gseaplot2(enrich_go_gsea[[onto]], geneSetID=1:4, title = enrich_go_gsea[[onto]]$Description[1], pvalue_table = TRUE) 
		print(go_pp)

		cat("<br>**Plot Name**<br>Plot text")
		go_pp <- gsearank(enrich_go_gsea[[onto]], geneSetID=1, title = enrich_go_gsea[[onto]]$Description[1])
		print(go_pp)
		cat("\n \n")
	}
}))
# }


# message("PLOTS SETS ALL UNIFIED")
cat("### **[All] Over Representation Analysis Unified**")
# Concat results
enr_go <- enrich_go[[1]]
if(length(enrich_go)>1){
	invisible(lapply(seq_along(enrich_go)[-1],function(i){
		enr_go@result <<- rbind(enr_go@result, enrich_go[[i]]@result)
	}))
}

# Plot
cat("<br>**Plot Name**<br>Plot text")
go_pp1  <- barplot(enr_go)
cat("<br>**Plot Name**<br>Plot text")
go_pp2  <- dotplot(enr_go, showCategory=30)
cat("<br>**Plot Name**<br>Plot text")
go_pp4  <- cnetplot(enr_go, showCategory = 15)
cat("<br>**Plot Name**<br>Plot text")
go_pp6  <- emapplot(enr_go, showCategory = 50)
cat("<br>**Plot Name**<br>Plot text")
go_pp8  <- heatplot(enr_go)
cat("<br>**Plot Name**<br>Plot text")
go_pp10 <- upsetplot(enr_go)

# Check vars to be plotted
plot_vars <- ls()[grepl("^go_pp",ls())]
plot_vars <- plot_vars[order(nchar(plot_vars),plot_vars)]
# Plot vars
invisible(lapply(plot_vars,function(var_name){
	print(get(var_name))
}))
# Remove plot vars
rm(list=plot_vars)

```



















```{r go_section, echo = FALSE}
# Prepare text to be rendered
headers <- list(GO_preval = "### **GO Prevalent DEGs:",
				GO_preval_overex = "### **GO Overexpressed functions from prevalent DEGs:",
				GO_preval_underex = "### **GO Underexpressed functions from prevalent DEGs:",
				GO_allpos = "### **GO All possible DEGs:",
				GO_allpos_overex = "### **GO Overexpressed functions from all possible DEGs:",
				GO_allpos_underex = "### **GO Underexpressed functions from all possible DEGs:")
bodies  <- list(GO_preval = "This is the GO graph concerning prevalent DEGs",
				GO_preval_overex = "This is the GO graph concerning the overexpressed prevalent DEGs:",
				GO_preval_underex = "This is the GO graph concerning the underexpressed prevalent DEGs:",
				GO_allpos = "This is the GO graph concerning all possible DEGs",
				GO_allpos_overex = "This is the GO graph concerning the overexpressed all possible DEGs:",
				GO_allpos_underex = "This is the GO graph concerning the underexpressed all possible DEGs")
ontos   <- list(BP = "Biological Process (BP)**",
				MF = "Molecular Function (MF)**",
				CC = "Cellular Component (CC)**")

if(!go_flags$GO_SECTION){
	out <- ""
}else{
	################## CHECK FIFLE BY FILE
	out <- unlist(lapply(graph_files,function(f){
		if(go_flags[[f]]){
			# Prepare file info
			splitted <- unlist(strsplit(f,"_"))
			basename <- paste(head(splitted,-1),collapse="_")
			# prepare render info
			header <- headers[[basename]] 
			body <- bodies[[basename]]
			onto <- ontos[[tail(splitted,1)]]
			label <- paste(header,onto,sep=" ")[1]
			# Paste and return
			return(knit_expand(text = paste(label,
											body,
											"<br>",
											chunks(code = paste("include_graphics('",go_files[[f]],"')"),
												   options = "echo = FALSE"),
											"\n",sep = "\n")))
		}else{
			return("")
		}
	}))

	# Add section header
	out <- c(knit_expand(text = "## **GO graphs**"),out)
}
# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
```

`r paste(knit(text = paste(out,collapse = "\n")),collapse = "\n")`

















```{r react_main,  results='asis', echo = FALSE, eval = react_flags$REACT_SECTION}
cat("## **REACTOME analysis**\n")
```





```{r react_ora, results='asis', echo = FALSE, eval = react_flags$enrich_react}
# Main label 
cat("### **Over Representation Analysis**\n")

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- barplot(enrich_react)
# Display plot
print(pp)


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- dotplot(enrich_react, showCategory=30)
# Display plot
print(pp)


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- cnetplot(enrich_react)
# Display plot
print(pp)


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- emapplot(enrich_react)
# Display plot
print(pp)


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- heatplot(enrich_react)
# Display plot
print(pp)


# # Plot label and text
# cat("**Plot Name**<br>Plot text")
# # Create plot
# pp <- upsetplot(enrich_react)
# # Display plot
# print(pp)
```







```{r react_gsea, results='asis', echo = FALSE, eval = react_flags$enrich_react_gsea}
# Main label
cat("### **Gene Set Enrichment Analysis**\n")


# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- dotplot(enrich_react_gsea, showCategory=30)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- cnetplot(enrich_react_gsea)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- emapplot(enrich_react_gsea)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- heatplot(enrich_react_gsea)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- ridgeplot(enrich_react_gsea)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- gseaplot2(enrich_react_gsea, geneSetID=1:4, title = enrich_react_gsea$Description[1], pvalue_table = TRUE)
# Display plot
print(pp)

# Plot label and text
cat("**Plot Name**<br>Plot text")
# Create plot
pp <- gsearank(enrich_react_gsea, geneSetID=1, title = enrich_react_gsea$Description[1])
# Display plot
print(pp)
```













